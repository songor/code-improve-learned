# 代码精进之路

### 开篇词 | 你写的每一行代码，都是你的名片

每一行代码，都体现着程序员的修为，思考问题的深度，甚至是处理问题的习惯和态度。

作为一名软件工程师，我们该怎么快速成长，并且保持长久的竞争力？

解决这个问题的终极方法，只有一个，那就是**持续地交付优秀的结果**。

### 01 | 从条件运算符说起，反思什么是好代码

坚持使用最直观的编码方式，而不是追求代码简短，真的可以避免很多不必要的错误。

关于优秀代码的特点，我想用**“经济”**这一个词语来表达。这里的“经济”，指的是使用较少的人力、物力、财力、时间、空间来获取较大的成果或收益。或者简单地说，投入少、收益大、投资回报高。

该怎么理解“经济”呢？这需要我们把代码放到软件的整个生命周期里来考察。

### 02 | 把错误关在笼子里的五道关卡

```c
    if ((error = doSomething()) != 0)
        goto fail;         
        goto fail;    
    if ((error= doMore()) != 0)        
        goto fail;
fail:    
    return error;
```

第一道关：程序员

提高程序员的修养，是一个永不过时的课题。从别人的失败和自己的失败中学习、积累、提高，是一个程序员成长的必修课。

首先，他应该正确使用缩进。其次，他应该使用大括号。

优秀的代码源于我们对细节的热情和执着。

第二道关：编译器

对于编译器的警告，我们一定要非常警觉。能消除掉所有的警告，你就应该消除掉所有的警告。就算实在没有办法消除掉编译警告，那你也一定要搞清楚警告产生的原因，并确认编译警告不会产生任何后续问题。

第三道关：回归测试

一般地，软件测试会尽可能地覆盖关键逻辑和负面清单，以确保关键功能能够正确执行，关键错误能够有效处理。

另外，这些测试代码还有一个关键用途就是做回归测试。如果有代码变更，我们可以用回归测试来检查代码变更有没有使代码变得更坏。

第四道关：代码评审

代码评审是一个有效的在软件研发过程中抵御人类缺陷的制度。通过更多的眼睛检查软件代码，被忽视的错误更容易被逮住，更好的设计和实现更容易浮现出来。

第五道关：代码分析

静态代码分析（Static Code Analysis）是通过对源代码的检查来发现潜在问题的一种软件质量保障方式。

代码覆盖率（Code Coverage）是一个反映测试覆盖程度的指标。它不仅仅量化测试的指标，也是一个检测代码缺陷的好工具。

**代码制造的流水线**

编写优秀的代码，不能仅仅依靠一个人的战斗。代码的优秀级别，依赖于每个关卡的优秀级别。高质量的代码，依赖于高质量的流水线。每道关卡都应该给程序员提供积极的反馈，这些反馈，在保障代码质量的同时，也能帮助程序员快速学习和成长。

### 03 | 优秀程序员的六个关键特质

**掌握一门编程语言**

对于编程语言，我们了解得越多，熟知的招式就越多，可选择的范围就越大，我们就有更多的活动空间和解决问题的办法。

**解决现实的问题**

只有理解了问题，看到了解决问题的价值，我们才能够真正解决好问题，并且从中获得满满的成就感。我们一定要记得，程序员的存在不是为了写代码，而是为了解决现实问题，实现现实价值。

如果说花样的工具是外家功夫，思维能力和行为能力可以算是内功。

优秀的程序员，是一个内外双修的程序员。如果一个程序员可以熟练使用工具，有清晰的解决问题思路，能明晰地传达产品价值，那么他编写代码就不存在什么巨大的困难了。

**发现关键的问题**

优秀的程序员，能够发现一门编程语言的缺陷，一个顺手工具的局限。所以，他知道该怎么选择最合适的工具，该怎么避免不必要的麻烦。

优秀的程序员，能够发现解决方案背后的妥协和风险。所以，他可以预设风险防范措施，设置软件的适用边界。

优秀的程序员，能够敏锐地观察到产品的关键问题，或者客户未被满足的需求。所以，他可以推动产品持续地进步和演化。

能够发现关键的问题，意味着我们可以从一个被动做事情的程序员，升级为一个主动找事情的程序员。

能够发现关键的问题，往往需要我们对一个领域有很深入的研究和深厚的积累，并且对新鲜事物保持充分的好奇心和求知欲。

**沉静的前行者**

优秀的程序员，一定是懂得妥协，懂得选择，一步一步把事情沉静地朝前推动的人。

对完美的过分追求，可能是一个代价高昂，收获甚小的行为。

而且，完美也可能意味着不承认缺陷，不承认未知。这样，我们可能在心理上就不会对代码的未知风险做出充分的预判，留出足够的安全缓冲空间。

**可以依赖的伙伴**

优秀的程序员，知道团队合作的重要性，是一个优秀的团队成员。

如果说，编程语言、花样工具、逻辑思维、解决问题这些“硬技能”可以决定我们的起点的话，影响力、人际关系这些“软技能”通常影响着我们可以到达的高度。

**时间管理者**

坚持把时间用在对的地方，用在价值更大的地方。

要做只有你才能做的事情。

要坚持做需要做的事情。不需要的、不紧急的、价值不大的我们可以暂时搁置起来。一个人能做的事情是有限的，能把最重要的事情最好，就已经很了不起了。

### 04 | 代码规范的价值：复盘苹果公司的 GoToFail 漏洞

**什么是编码规范？**

编码规范指的是针对特定编程语言约定的一系列规则，通常包括文件组织、缩进、注释、声明、语句、空格、命名约定、编程实践、编程原则和最佳实践等。

编码规范可以帮我们选择编码风格、确定编码方法，以便更好地进行编码实践。简单地说，一旦学会了编码规范，并且严格地遵守它们，可以让我们的工作更简单，更轻松，少犯错误。

**规范的代码，可以降低代码出错的几率**

复杂是代码质量的敌人。越复杂的代码，越容易出现问题，并且由于复杂性，我们很难发现这些隐藏的问题。

所以在编码的时候，我们应该尽量使代码风格直观、逻辑简单、表述直接。

**规范的代码，可以提高编码的效率**

在代码制造的每一道关卡，规范执行得越早，问题解决得越早，整个流水线的效率也就越高。

**规范的代码，降低软件维护成本**

在一个软件生命周期里，软件维护阶段花费了大约 80% 的成本。

代码问题修改的过程包含了很多角色：代码的编写者、代码的使用者、问题的审阅者以及问题的解决者，这些角色一般不是同一个人。在修改代码时，不管我们是其中的哪一个角色，遵守规范的代码都能够节省我们的时间。

很多软件代码，其生命的旅程超越了它的创造者，超越了团队的界限，超越了组织的界限，甚至会进入我们难以预想的领域。

严格遵守共同的编码规范，提高代码的可读性，可以使参与其中的人更容易地理解代码，更快速地理解代码，更快速地解决问题。

**编码规范越使用越高效**

如果我们像乘法表一样熟练使用编码规范，一旦遇到没有使用大括号的语句，我们就会非常警觉。因为，不使用大括号的编码方式不符合我们习以为常的惯例，快系统立即就能判别出异常状况，然后交给慢系统做进一步的思考。

所以，我们要尽早地使用编码规范，尽快地培养对代码风格的敏感度。

优秀的代码不光是给自己看的，也是给别人看的，而且首先是给别人看的。

### 05 | 经验总结：如何给你的代码起好名字？

**为什么需要一个好名字？**

名字要准确地代表它背后的东西，并且还能让代码干净漂亮。

名字就是沟通的方式，错误的命名很难让我们清楚地理解代码真实的意图。所以，混淆的命名很难让我们阅读和理解代码。

**为什么需要命名规范？**

使代码审核变得更有效率，专注于更重要的问题，而不是争论语法和命名规范这类小细节；

提高代码的清晰度、可读性以及美观程度；

**有哪些常见的命名方法？**

*驼峰命名法*

驼峰命名法指的是使用大小写混合的格式，单词之间不使用空格隔开或者连接字符连接的命名方式。

Google 定义了以下的转换规则：

从正常的表达形式开始，把短语转换成 ASCII 码，并且移除单引号。

如果上述结果含有其他标点符号（比如连字符），在该符号处把这个结果切分成单词形式。如果某个单词已经是驼峰形式，也相应地切分开来。

将所有字母转换为小写字母，然后将每个单词的首字母大写，这样就得到了大驼峰式命名的形式；如果第一个单词的首字母小写，就得到了小驼峰式命名的形式。

将所有的单词连在一起，就是最后的标识符命名。

| 短语                 | 正确的转换形式    | 错误的转换形式    |
| -------------------- | ----------------- | ----------------- |
| XML HTTP request     | XmlHttpRequest    | XMLHTTPRequest    |
| new customer ID      | newCustomerId     | newCustomerID     |
| inner stopwatch      | innerStopwatch    | innerStopWatch    |
| supports IPv6 on iOS | supportsIpv6OnIos | supportsIPv6OnIOS |

*蛇形命名法*

单词之间通过下划线“_”连接。

*串式命名法*

单词之间通过连字符“-”连接。

*匈牙利命名法*

标识符由一个或者多个小写字母开始，这些字母用来标识标识符的类型（系统匈牙利命名法）或者用途（应用匈牙利命名法）。标识符的剩余部分，可以采取其他形式的命名法。

**Java 命名规范**

| 标识符类型        | 适用命名方法                                                 |
| ----------------- | ------------------------------------------------------------ |
| package           | 使用名词；包名全部小写；不能使用连接符；尽量使用单个名词作为包名。 |
| class / interface | 使用名词或者名词短语，接口也可以使用形容词；大驼峰命名法；尽量避免使用缩略语。 |
| 方法              | 通常使用动词或者动词短语；小驼峰命名法；尽量避免使用缩略语。 |
| 变量              | 小驼峰命名法，尽量避免使用单个字符命名（用完即扔的少数特例除外） |
| 常量              | 蛇形命名法；使用大写字母。                                   |

**怎么取好名字？**

*要有准确的意义*

*严格遵守命名规范*

*可读性优先*

可读性强的名字优先于简短的名字，尽量使用完整的词汇；

不要使用缩写、简写、缩略词，除非这些词语被广泛使用；

不要使用太短的名字，比如一个字母，除非是广泛接受的特例；

避免含糊、混淆或者误导；

不要混合使用英文和汉语拼音。

“信、达、雅”（准确、直观、优美）

### 06 | 代码整理的关键逻辑和最佳案例

把代码分割成大脑能够有效识别并记忆的信息块，通过合理地使用空行、空格和缩进，把这些信息块清晰地呈现出来。

**给代码分块**

保持代码块的单一性，一个代码块只能有一个目标。

注意代码块的完整性。一个代码块要表达一个相对完整的意思，不能一个意思没说完就分块了。

代码块数量要适当。一个基础的代码块最好不要超过 25 行。

**使用空白空间**

靠近的代码会形成一个视觉块，并且具有隐含的关联。分开的代码，意味着上下两段代码的关联没有那么紧密。

*同级别代码块靠左对齐*

*同级别代码块空行分割*

*下一级代码块向右缩进*

由于我们倾向于使用有准确意义的命名，标识符的长度往往是一个不能忽视的因素。现在的编码规范，四个空格的缩进最为常见，二个空格的缩进次之，八个空格的缩进使用的较少。

*同行内代码块空格区隔*

**一行一个行为**

一般一个完整的表达式可以看作是一个独立的行为。

**基本的换行原则**

每行代码字符数的限制。一般情况下，每行代码不要超出 80 个字符（ 80 个字符是传统终端的宽度，比如 vi 编译器）。由于屏幕尺寸和代码阅读终端的变化，现在的很多规范开始使用 120 个字符的限制。

如果一行不足以容纳一个表达式，就需要换行。

在逗号后换行；

在操作符前换行；

高级别的换行优先；尽量把同一优先级的表达式保留在同一行，和低级别的区别开来。

```java
// conventional indentation
int runningMiles = runningSpeedOne * runningTimeOne
                 + runningSpeedTwo * runningTimeTwo;

// confusing indentation                           
int runningMiles = runningSpeedOne
       * runningTimeOne + runningSpeedTwo
       * runningTimeTwo;
```

新的换行与上一行同级别表达式的开头对齐；

如果上述规则导致代码混乱或者代码太靠右，使用 8 个空格作为缩进（两个缩进单位）。

```java
// bad indentation
if ((conditionOne && conditionTwo)
    || (conditionThree && conditionFour)) {
    doSomething();  
}

// a better indentation, using 8 spaces for the indentation
if ((conditionOne && conditionTwo)
        || (conditionThree && conditionFour)) {
    doSomething();  
}
```

### 07 | 写好注释，真的是小菜一碟吗？

注释是用来提高代码的可读性和可维护性的。不要让注释偏离了这个原则，破坏了代码的逻辑和可读性。

Code Tells You How, Comments Tell You Why.

**注释是无奈的妥协**

正如一个作家无法预料他的读者能否清晰地理解他的文字一样，一个程序员也不能判断他的读者能否清晰地理解他写的代码。

因为注释不需要运行，所以没有常规的办法来测试它。注释难以维护，这是使用注释带来的最大的麻烦。

注释为我们提供了一个借口。我们有时候会过度依赖解释，从而放弃了潜在的替代方案，比如更准确的命名，更清晰的结构，更顺畅的逻辑等等。

注释的滥用。由于注释部分不被执行，那么就可以被用来注释掉一些不需要的东西。

总结一下，注释是代码的一部分，是需要阅读的内容，目的是让其他人能更好地理解我们的代码，写注释需要我们有“用户思维”。

**几种常见注释类型**

**第一种类型，是记录源代码版权和授权的**，一般放在每一个源文件的开头，说明源代码的版权所有者，以及授权使用的许可方式，或者其他的公共信息。

**第二种类型，是用来生成用户文档的**，比如 Java Doc。这些文档帮助使用者了解软件的功能和细节，主要面向的是该软件的使用者，而不是该软件的开发者。

**第三种类型，是用来解释源代码的**。换句话说，就是帮助代码的阅读者理解代码。

**简化注释的风格**

针对第一种注释类型，也就是固定的版权和授权信息，使用一般的星号注释符。

```java
/*
 * Copyright (c) 2022, Song Yu Chen. All rights reserved.
 */
```

针对第二种注释类型，即生成用户文档的注释，使用 Javadoc 要求的格式，文档注释符。

```java
/**
 * A {@code Readable} is a source of characters. Characters from
 * a {@code Readable} are made available to callers of the read
 * method via a {@link java.nio.CharBuffer CharBuffer}.
 *
 * @since 1.5
 */
public interface Readable {
    ...
}
```

针对第三种注释类型，也就是代码解释注释，只使用行注释符。

```java
// Verify that the buffer has sufficient remaining
private static void verifyLength(
        ByteBuffer buffer, int requiredLength) {
    ...
}

String myString;  // using end-to-line comment

// This is a multiple line comment.  This is a multiple
// line comment. 
if (!myString.isEmpty()) {
    ...
}
```

如果一段代码不再需要，我会清理掉代码，而不会保留这个注释掉的代码块。不要在源代码里记录代码历史，那是代码版本管理系统该干的事情。

**注释的三项原则**

**准确**，错误的注释比没有注释更糟糕。

**必要**，多余的注释浪费阅读者的时间。

**清晰**，混乱的注释会把代码搞得更乱。如果注释和代码不能从视觉上清晰地分割，注释就会破坏代码的可读性。

另外，不要在代码里标注你想要做的工作和已经做过的工作。比如使用 TODO，记录代码更改记录等等。

特别需要注意的是，我们可以使用临时的调试语句，但是，不要把代码的调试语句保留在提交的代码里。

### 08 | 写好声明的“八项纪律”

在 Java 语言里，声明可以用来定义类、方法、类变量、局部变量和常量。

**取一个好名字**

**一行一个声明**

需要注意的是，表示数组的中括号 [] 是类型的一部分，而不是标识符的一部分。

```java
// 反面案例
int entries[];
// 正面案例
int[] entries;
```

**局部变量需要时再声明**

**类属性要集中声明**

**声明时就初始化**

除非变量的初始值依赖于更多的条件，或者涉及到一定的计算，否则，声明时就应该完成初始化。

**尾随的花括号**

左括号不要单独成行，要紧随在语句尾部，以一个空格隔开；右括号单独一行。

**靠紧的小括号**

**搜索优化的换行**

常见的搜索模式有：

“public class”

“abstract class”

“class TheClassName”

“extends TheClassName”

“implements TheInterfaceName”

“theMethodName(”

语义相关的词语，常见的搜索模式，要尽量放在同一行。

### 09 | 怎么用好 Java 注解？

Override / Deprecated / SuppressWarnings

**在声明继承关系中，Java 注解该如何使用？**

第一个麻烦是，识别子类的方法是不是重写方法。

如果一个方法是重写方法，一定要使用 Override 注解，清楚地标明这个方法是重写的方法。

第二个麻烦是，重写方法可以不遵守父类方法的规范。

一般来说，一个重写方法不应该改变父类定义的规范。如果的确需要改变，就要有充足的理由，以及面对潜在兼容问题的解决办法。

如果重写方法既没有改变父类规范，也没有其他情况需要重点说明，重写方法就不应该有规范描述部分的存在。

```java
// 重写方法严格遵守父类定义的规范
class Student extends Person {
    @Override
    public String getFirstName() {
        // snipped
    }
}
```

```java
// 重写方法改写了父类定义的规范
class Student extends Person {
    /**
     * Get the first name of the student.
     *
     * Note that the returned value may be null if ...
     */
    @Override
    public String getFirstName() {
        // snipped
        return null;
    }
}
```

**在废弃退役接口的情况下，如何使用注解？**

第一件事情是，如果接口的设计存在不合理性，或者新方法取代了旧方法，我们应该尽早地废弃该接口。

对于代码而言，要在声明中使用 Deprecated 注解；在规范描述中，说明废弃的原因以及替代的办法；对于有计划要删除的接口，注明计划删除的版本号。

第二件事情是，如果我们在现有的代码中使用了废弃的接口，要尽快转换、使用替换的方法。

